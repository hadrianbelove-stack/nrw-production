#!/usr/bin/env bash
set -euo pipefail
cd ~/Downloads/new-release-wall

echo "ğŸš€ NRW Preflight Check"

# Check UI Lock first
if [[ -f ui_lock.sh ]]; then
  echo "Checking UI Lock integrity..."
  if ./ui_lock.sh verify; then
    echo "âœ“ UI templates verified"
  else
    echo "âš ï¸  UI templates compromised - attempting auto-fix..."
    ./ui_lock.sh auto-fix || {
      echo "âŒ PREFLIGHT FAILED: Could not restore UI templates"
      exit 1
    }
  fi
else
  echo "âš ï¸  No UI Lock found"
fi

# Check virtual environment
if [[ -d .venv ]]; then
  source .venv/bin/activate
  echo "âœ“ Virtual environment activated"
else
  echo "âš ï¸  No virtual environment found"
fi

# Check critical files
CRITICAL_FILES=(
  "generate_site.py"
  "movie_tracker.py" 
  "new_release_wall_balanced.py"
  "templates/site_enhanced.html"
  "config.yaml"
)

for file in "${CRITICAL_FILES[@]}"; do
  if [[ -f "$file" ]]; then
    echo "âœ“ $file"
  else
    echo "âŒ MISSING: $file"
    exit 1
  fi
done

# Check API keys
if python3 -c "import yaml; cfg=yaml.safe_load(open('config.yaml')); exit(0 if cfg.get('tmdb_api_key') and 'YOUR' not in cfg.get('tmdb_api_key','') else 1)" 2>/dev/null; then
  echo "âœ“ TMDB API key configured"
else
  echo "âš ï¸  TMDB API key missing or placeholder"
fi

if python3 -c "import yaml; cfg=yaml.safe_load(open('config.yaml')); exit(0 if cfg.get('omdb_api_key') and 'YOUR' not in cfg.get('omdb_api_key','') else 1)" 2>/dev/null; then
  echo "âœ“ OMDB API key configured"
else
  echo "âš ï¸  OMDB API key missing or placeholder"
fi

echo "ğŸš€ Preflight check completed"
