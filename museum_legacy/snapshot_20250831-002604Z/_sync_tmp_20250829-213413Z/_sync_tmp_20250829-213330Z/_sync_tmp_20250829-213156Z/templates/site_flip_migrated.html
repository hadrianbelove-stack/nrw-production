<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>New Release Wall</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,sans-serif;background:#0a0a0a;color:#fff;line-height:1.6}
.header{text-align:center;padding:2rem 1rem;background:linear-gradient(180deg,#1a1a1a 0%,#0a0a0a 100%);border-bottom:1px solid #333}
.header h1{font-size:2.2rem;font-weight:300;letter-spacing:.05em;margin-bottom:.5rem}
.header .subtitle{color:#888;font-size:1rem}
.movie-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:2rem;padding:2rem;max-width:1400px;margin:0 auto}
.movie-card{position:relative;width:100%;aspect-ratio:2/3;transform-style:preserve-3d;transition:transform .6s;cursor:pointer}
.movie-card.flipped{transform:rotateY(180deg)}
.card-face{position:absolute;width:100%;height:100%;backface-visibility:hidden;border-radius:8px;overflow:hidden;background:#1a1a1a}
.card-front{z-index:2}
.card-back{transform:rotateY(180deg);background:linear-gradient(135deg,#1a1a1a 0%,#2a2a2a 100%);padding:1rem;display:flex;flex-direction:column;color:#fff;position:relative}
.movie-poster{width:100%;height:75%;object-fit:cover;background:#2a2a2a}
.movie-info{padding:.75rem;background:linear-gradient(180deg,#1a1a1a 0%,#0a0a0a 100%);height:25%;display:flex;flex-direction:column;justify-content:center}
.movie-title{font-size:.95rem;font-weight:600;margin-bottom:.25rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.movie-year{font-size:.8rem;color:#888;margin-bottom:.25rem}
.movie-credits{font-size:.75rem;color:#aaa;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;margin-bottom:.5rem}
.provider-links{display:flex;flex-wrap:wrap;gap:.25rem}
.provider-btn{background:#333;color:#fff;padding:.25rem .5rem;border-radius:4px;font-size:.7rem;text-decoration:none;transition:background .3s}
.provider-btn:hover{background:#555}
.back-header{margin-bottom:1rem}
.back-title{font-size:1.05rem;font-weight:600;margin-bottom:.5rem}
.back-meta{display:flex;flex-wrap:wrap;gap:.5rem;font-size:.75rem;color:#aaa;margin-bottom:.5rem}
.back-meta span{background:#333;padding:.25rem .5rem;border-radius:4px}
.synopsis{flex:1;font-size:.8rem;line-height:1.4;color:#ccc;overflow-y:auto;margin-bottom:1rem}
.back-links{display:flex;gap:.5rem}
.trailer-btn,.watch-btn{flex:1;padding:.5rem;background:#e50914;color:#fff;border:none;border-radius:4px;text-decoration:none;text-align:center;font-size:.75rem;transition:all .3s}
.watch-btn{background:#333}
.trailer-btn:hover{background:#ff0a16}
.watch-btn:hover{background:#555}
.rt-badge{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.6);padding:.25rem .4rem;border-radius:4px;font-size:.75rem}
@media (max-width:768px){.movie-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:1rem;padding:1rem}.header h1{font-size:1.8rem}}
</style>
</head>
<body>
<div class="header">
  <h1>The New Release Wall</h1>
  <div class="subtitle">What's New to Digital This Week</div>
</div>

<div class="movie-grid">
{% for item in movies %}
  {% set title = item.title %}
  {% set year  = item.year %}
  {% set poster = item.poster_url or '/assets/placeholder_poster.svg' %}
  {% set rt = (item.rt_score ~ '%') if item.rt_score is not none else '—' %}
  {% set studio = item.studio or '—' %}
  {% set runtime = (item.runtime_minutes ~ ' min') if item.runtime_minutes else '—' %}
  {% set synopsis = item.synopsis or '' %}
  {% set providers = item.providers %}
  {% if providers is mapping %}
    {% set p_stream = providers.stream or [] %}
  {% elif providers is sequence %}
    {% set p_stream = providers %}
  {% else %}
    {% set p_stream = [] %}
  {% endif %}
  {% set watch_url = item.amazon_url or item.store_url or item.tmdb_watch_link or item.trailer_url or '#' %}
  {% set rt_url = item.rt_url or 'https://www.rottentomatoes.com/search?search=' ~ (title|string) %}

  <div class="movie-card" onclick="this.classList.toggle('flipped')">
    <div class="card-face card-front">
      <img src="{{ poster }}" alt="{{ title }}" class="movie-poster" loading="lazy" decoding="async"
           onerror="this.onerror=null;this.src='/assets/placeholder_poster.svg'">
      <div class="movie-info">
        <div class="movie-title">{{ title }}</div>
        <div class="movie-year">{{ year }}</div>
        <div class="movie-credits">
          {% if item.director %}Dir: {{ item.director }}{% endif %}
          {% if item.cast %} • {{ (item.cast[:2])|join(', ') }}{% endif %}
        </div>
        <div class="provider-links">
          {% for _ in p_stream[:3] %}
            <a href="{{ watch_url }}" class="provider-btn">Watch</a>
          {% endfor %}
        </div>
      </div>
      <div class="rt-badge"><a href="{{ rt_url }}" target="_blank" rel="noopener" style="color:#fff;text-decoration:none">{{ rt }}</a></div>
    </div>

    <a class="card-face card-back" href="{{ watch_url }}" target="_blank" rel="noopener" onclick="event.stopPropagation()">
      <div class="back-header">
        <div class="back-title">{{ title }}</div>
        <div class="back-meta">
          <span>{{ studio }}</span>
          <span>{{ runtime }}</span>
          <span>RT: {{ rt }}</span>
        </div>
      </div>
      <div class="synopsis">
        {{ synopsis|default("No synopsis available", true)|truncate(240) }}
      </div>
      <div class="back-links">
        <a href="{{ item.trailer_url or '#' }}" class="trailer-btn" target="_blank" rel="noopener" onclick="event.stopPropagation()">▶ Trailer</a>
        <a href="{{ watch_url }}" class="watch-btn" target="_blank" rel="noopener" onclick="event.stopPropagation()">Watch Options</a>
      </div>
    </a>
  </div>
{% endfor %}
</div>

<!-- NRW_FIX_02 -->
<style>
  /* Bigger, fixed card so rows don't overlap */
  .movie-card{ width:180px; height:320px; aspect-ratio:auto !important; }
  .movie-card-inner{ width:100%; height:100%; }
  .movie-poster{ height:70%; object-fit:cover; }
  .back-synopsis{ flex:1; overflow-y:auto; }
</style>
<script>
(() => {
  /* Unwrap invalid <a.card-back> -> <div.card-back> */
  document.querySelectorAll('a.card-face.card-back').forEach(a => {
    const div = document.createElement('div');
    div.className = a.className;
    if (a.getAttribute('style')) div.setAttribute('style', a.getAttribute('style'));
    while (a.firstChild) div.appendChild(a.firstChild);
    a.parentNode.replaceChild(div, a);
  });

  /* Remove full-surface overlay link */
  document.querySelectorAll('.card-back .card-back-link').forEach(el => el.remove());

  /* Hide RT button when broken */
  document.querySelectorAll('.mini-btn.btn-rt').forEach(btn => {
    const href = (btn.getAttribute('href')||'').trim();
    if (!href || href === 'None' || href === '#') btn.remove();
  });

  /* Kill any auto-reload timers (debugging) */
  try { const max = setInterval(()=>{},1000); for (let i=0;i<=max;i++) clearInterval(i); } catch(e){}
})();
</script>

</body>
</html>